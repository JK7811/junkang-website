<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JKang Neon Arena</title>
  <meta name="description" content="Recharge Â· Fight Â· Upgrade Â· Weapons Â· Idle Â· Crazy FX" />
  <style>
    :root{
      --bg:#050507; --text:#F6F7FB; --muted:#A7AAB5; --line:rgba(255,255,255,.12);
      --glass:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.02);
      --shadow:0 26px 90px rgba(0,0,0,.62); --radius:22px;
      --gold:#FFD700; --good:#78ffb4; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(900px 520px at 18% 30%, rgba(255,215,130,.18), transparent 60%),
        radial-gradient(900px 520px at 80% 72%, rgba(120,200,255,.14), transparent 60%),
        radial-gradient(780px 480px at 62% 20%, rgba(180,120,255,.14), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    canvas#fx, canvas#arena{ position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:0; }
    canvas#arena{ pointer-events:auto; z-index:1; }
    .noise{ position:fixed; inset:0; z-index:2; pointer-events:none; opacity:.10; mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
    }
    .glow{ position:fixed; width:560px; height:560px; border-radius:50%; transform:translate(-50%,-50%);
      background: radial-gradient(circle at center, rgba(255,215,130,.16) 0%, rgba(180,120,255,.12) 24%, rgba(120,200,255,.10) 46%, rgba(255,255,255,0) 62%);
      filter: blur(2px); z-index:3; pointer-events:none; mix-blend-mode:screen;
    }

    .ui{ position:relative; z-index:4; max-width:1120px; margin:0 auto; padding:16px 14px 80px; }
    .nav{ position:sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between;
      padding:12px 0; border-bottom:1px solid var(--line); backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(5,5,7,.90), rgba(5,5,7,.40));
    }
    .brand{ display:flex; gap:10px; align-items:center; font-weight:1000; letter-spacing:.25em; text-transform:uppercase; font-size:13px; }
    .dot{ width:10px; height:10px; border-radius:50%; background: radial-gradient(circle, rgba(255,215,130,1), rgba(255,215,130,.1)); box-shadow:0 0 18px rgba(255,215,130,.35); }
    .links{ display:flex; gap:10px; color:var(--muted); font-size:13px; flex-wrap:wrap; align-items:center; }
    .links a, .links button{ padding:8px 10px; border-radius:999px; border:1px solid transparent; background:transparent; color:inherit; cursor:pointer; }
    .links a:hover, .links button:hover{ border-color:var(--line); color:var(--text); transform: translateY(-1px); background: rgba(255,255,255,.03); }

    .card{ border:1px solid var(--line); border-radius:var(--radius); background: linear-gradient(to bottom, var(--glass), var(--glass2));
      box-shadow:var(--shadow); overflow:hidden; position:relative;
    }
    .card::before{ content:""; position:absolute; inset:-1px; background: linear-gradient(135deg, rgba(255,215,130,.18), rgba(180,120,255,.12), rgba(120,200,255,.10), rgba(255,255,255,0));
      opacity:.22; pointer-events:none;
    }
    .in{ position:relative; padding:16px; }
    .kicker{ display:inline-flex; gap:10px; align-items:center; letter-spacing:.18em; text-transform:uppercase; font-size:12px; color:rgba(255,255,255,.85); }
    .pulse{ width:10px; height:10px; border-radius:50%; background: rgba(120,255,180,.95); box-shadow:0 0 18px rgba(120,255,180,.45); animation:pulse 1.6s ease-in-out infinite; }
    @keyframes pulse{0%,100%{transform:scale(1);opacity:.8}50%{transform:scale(1.35);opacity:1}}
    h1{ margin:10px 0 10px; font-size:56px; line-height:1.03;
      background: linear-gradient(90deg,#fff,#FFD700,#FFB800,#B478FF,#7CC8FF);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow:0 0 28px rgba(255,215,130,.10);
    }
    .sub{ color:var(--muted); font-size:14px; line-height:1.9; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; align-items:center; }

    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px; border-radius:14px; border:1px solid var(--line);
      background: rgba(255,255,255,.06); box-shadow:0 12px 34px rgba(0,0,0,.35);
      transition:.2s; font-weight:1000; cursor:pointer; user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn.primary{ background: rgba(255,255,255,.92); color:#000; border-color:transparent; }
    .btn.primary:hover{ background:#fff; }
    .btn.danger{ border-color: rgba(255,120,120,.35); }

    .statGrid{ display:grid; gap:10px; grid-template-columns:1fr 1fr; margin-top:14px; }
    .stat{ border:1px solid rgba(255,255,255,.12); border-radius:18px; background: rgba(255,255,255,.04); padding:12px; }
    .stat .t{ font-size:12px; color:var(--muted); letter-spacing:.12em; text-transform:uppercase; }
    .stat .v{ margin-top:8px; font-size:18px; font-weight:1000; }
    .bar{ height:10px; border-radius:999px; background: rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.10); }
    .bar > i{ display:block; height:100%; width:50%; background: linear-gradient(90deg, rgba(120,200,255,.85), rgba(180,120,255,.85), rgba(255,215,130,.85)); }

    .shopGrid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px; }
    @media(min-width:980px){ .wrap2{ display:grid; grid-template-columns:1.08fr .92fr; gap:14px; } .shopGrid{ grid-template-columns:1fr 1fr; } }
    .item{ border:1px solid rgba(255,255,255,.12); border-radius:18px; background: rgba(255,255,255,.04); padding:14px; transition:.2s; }
    .item:hover{ transform: translateY(-2px); background: rgba(255,255,255,.07); }
    .item h3{ margin:0; font-size:16px; }
    .item p{ margin:8px 0 0; color:var(--muted); font-size:13px; line-height:1.7; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.25); font-size:12px; color:rgba(255,255,255,.88); }
    .pill b{ color:#fff; }
    .mini{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .muted{ color:var(--muted); font-size:12px; line-height:1.7; }

    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); z-index:50;
      padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.55); backdrop-filter:blur(10px); color:rgba(255,255,255,.92); font-size:13px;
      box-shadow:0 18px 60px rgba(0,0,0,.55); opacity:0; transition:.2s; pointer-events:none;
      max-width:min(92vw,740px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
  </style>
</head>
<body>
  <canvas id="fx"></canvas>
  <canvas id="arena"></canvas>
  <div class="noise"></div>
  <div class="glow" id="glow"></div>
  <div class="toast" id="toast"></div>

  <div class="ui">
    <div class="nav">
      <div class="brand"><span class="dot"></span>JKANG NEON ARENA</div>
      <div class="links">
        <a href="#play">Play</a>
        <a href="#up">Upgrades</a>
        <button onclick="openLogin()">Login</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="wrap2">
      <section class="card" id="play">
        <div class="in">
          <div class="kicker"><span class="pulse"></span>Recharge Â· Fight Â· Upgrade Â· Idle</div>
          <h1>å¯¹æ‰“ç«æŠ€åœº<br/>æ­¦å™¨å‡çº§ + æŒ‚æœº</h1>
          <div class="sub">
            å……å€¼è´­ä¹° Coinsï¼ˆæ— æç°ï¼‰â†’ ç”¨ Coins è¿›è¡Œæˆ˜æ–—/å‡çº§ã€‚<br/>
            æš´å‡»ä¼šçˆ†é—ª+éœ‡å±+ç²’å­çˆ†ç‚¸ï¼›æŒ‚æœºå¼€å¯åè‡ªåŠ¨æ‰“æ€ªã€‚<br/>
            <span style="color:#fff">ç†æ€§æ¶ˆè´¹ï¼š</span>å»ºè®®è®¾ç½®æ¯æ—¥ä¸Šé™ï¼ˆåç»­æ¥ Supabase åå°å¯æ§ï¼‰ã€‚
          </div>

          <div class="row">
            <button class="btn primary" onclick="attackManual()">âš”ï¸ Attack (-1 coin)</button>
            <button class="btn" onclick="toggleIdle()" id="idleBtn">ğŸ¤– Idle: OFF</button>
            <button class="btn" onclick="refreshWallet()">ğŸ”„ Refresh</button>
          </div>

          <div class="statGrid">
            <div class="stat">
              <div class="t">Account</div>
              <div class="v" id="acct">Not logged in</div>
              <div class="muted">è¯·å…ˆ Login æ‰èƒ½å……å€¼ & åŒæ­¥é’±åŒ…</div>
            </div>
            <div class="stat">
              <div class="t">Coins</div>
              <div class="v" id="coins">0</div>
              <div class="muted">æ¥è‡ªå……å€¼ & æˆ˜æ–—å¥–åŠ±</div>
            </div>
            <div class="stat">
              <div class="t">Player</div>
              <div class="v" id="pLine">Lv.1 Â· HP 100/100</div>
              <div class="bar"><i id="pBar"></i></div>
            </div>
            <div class="stat">
              <div class="t">Enemy</div>
              <div class="v" id="eLine">Slime Â· HP 80/80</div>
              <div class="bar"><i id="eBar"></i></div>
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <span class="pill">å……å€¼ï¼ˆSGDï¼‰</span>
            <button class="btn primary" onclick="topup('topup_100')">+100 Â· $1.99</button>
            <button class="btn primary" onclick="topup('topup_300')">+300 Â· $4.99</button>
            <button class="btn primary" onclick="topup('topup_800')">+800 Â· $9.99</button>
          </div>

          <div class="muted" style="margin-top:10px">
            è¯´æ˜ï¼šCoins ä»…ç”¨äºå¨±ä¹æ¸¸æˆå†…æ¶ˆè´¹ï¼›ä¸æä¾›ç°é‡‘å…‘æ¢/æç°ã€‚
          </div>
        </div>
      </section>

      <section class="card" id="up">
        <div class="in">
          <div class="kicker"><span class="pulse"></span>Upgrades</div>
          <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap">
            <div>
              <div style="font-size:18px;font-weight:1000">å‡çº§ç³»ç»Ÿ</div>
              <div class="sub">å‡çº§ä¼šå½±å“ä¼¤å®³ã€æ”»é€Ÿã€æš´å‡»ã€æ­¦å™¨è¿›åŒ– & ç‰¹æ•ˆå¼ºåº¦ã€‚</div>
            </div>
            <div class="pill"><b id="weaponName">Rust Blade</b> Â· Weapon Lv.<b id="wLv">1</b></div>
          </div>

          <div class="shopGrid">
            <div class="item">
              <h3>ğŸ’¥ Damage +</h3>
              <p>æ”»å‡»æ›´ç–¼ï¼Œçˆ†ç‚¸æ›´çŒ›ã€‚</p>
              <div class="mini">
                <span class="pill">Cost <b id="cDmg">15</b></span>
                <button class="btn primary" onclick="buy('dmg')">Upgrade</button>
              </div>
            </div>

            <div class="item">
              <h3>âš¡ Attack Speed +</h3>
              <p>æ”»é€Ÿæ›´å¿«ï¼ŒæŒ‚æœºæ›´çˆ½ã€‚</p>
              <div class="mini">
                <span class="pill">Cost <b id="cSpd">22</b></span>
                <button class="btn primary" onclick="buy('spd')">Upgrade</button>
              </div>
            </div>

            <div class="item">
              <h3>ğŸ¯ Crit Chance +</h3>
              <p>æš´å‡»æ›´é¢‘ç¹ï¼ˆçˆ†é—ª+éœ‡å±ï¼‰ã€‚</p>
              <div class="mini">
                <span class="pill">Cost <b id="cCrit">30</b></span>
                <button class="btn primary" onclick="buy('crit')">Upgrade</button>
              </div>
            </div>

            <div class="item">
              <h3>ğŸ—¡ï¸ Weapon Upgrade</h3>
              <p>æ­¦å™¨è¿›åŒ–ï¼šæ›´å¼ºã€æ›´ç‚«ã€æ›´çˆ†ã€‚</p>
              <div class="mini">
                <span class="pill">Cost <b id="cWeap">80</b></span>
                <button class="btn primary" onclick="buy('weap')">Evolve</button>
              </div>
            </div>
          </div>

          <div class="muted" style="margin-top:10px">
            ä½ è¦â€œåå°å¯æ§â€ï¼šä¸‹ä¸€æ­¥æˆ‘ç»™ä½  admin.html + Supabase æƒé™ + æ—¥å¿—é¢æ¿ã€‚
          </div>
        </div>
      </section>
    </div>

    <footer style="margin-top:14px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;opacity:.92">
      <div>Tap arena canvas to dash</div>
      <div>Â© <span id="y"></span> JKang</div>
    </footer>
  </div>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG (å¡«ä½ Vercelç¯å¢ƒå˜é‡é‡Œçš„ anon key / url) ======
    // ä½ åªéœ€è¦æŠŠä¸‹é¢ä¸¤è¡Œæ›¿æ¢æˆä½ çš„ Supabaseï¼š
    const SUPABASE_URL = "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id)=>document.getElementById(id);
    $("y").textContent = new Date().getFullYear();

    // mouse glow
    const glow = $("glow");
    window.addEventListener("pointermove",(e)=>{
      glow.style.left = e.clientX+"px"; glow.style.top = e.clientY+"px";
      document.documentElement.style.setProperty("--mx", e.clientX+"px");
      document.documentElement.style.setProperty("--my", e.clientY+"px");
    },{passive:true});

    // toast
    let toastT;
    function toast(msg){
      clearTimeout(toastT);
      $("toast").textContent = msg;
      $("toast").style.opacity="1";
      toastT = setTimeout(()=> $("toast").style.opacity="0", 1600);
    }

    // ===== Auth (Email OTP) =====
    async function openLogin(){
      const email = prompt("è¾“å…¥é‚®ç®±ï¼ˆç”¨äºç™»å½•/å……å€¼åŒæ­¥é’±åŒ…ï¼‰ï¼š");
      if(!email) return;
      const { error } = await supabase.auth.signInWithOtp({ email });
      if(error){ toast("Login error: "+error.message); return; }
      toast("å·²å‘é€éªŒè¯ç /ç™»å½•é“¾æ¥åˆ°é‚®ç®±");
    }
    window.openLogin = openLogin;

    async function logout(){
      await supabase.auth.signOut();
      toast("Logged out");
      syncAccount();
    }
    window.logout = logout;

    async function syncAccount(){
      const { data } = await supabase.auth.getUser();
      const u = data?.user;
      $("acct").textContent = u ? (u.email || u.id) : "Not logged in";
      if(u) await refreshWallet();
    }

    // ===== Wallet (Supabase) =====
    let walletCoins = 0;

    async function refreshWallet(){
      const { data: userData } = await supabase.auth.getUser();
      const user = userData?.user;
      if(!user){ toast("è¯·å…ˆ Login"); return; }

      // ensure wallet exists (server will upsert too, but we read first)
      let { data: w, error } = await supabase.from("wallets").select("coins").eq("user_id", user.id).maybeSingle();
      if(error){ toast("Wallet read error"); return; }

      if(!w){
        // can't insert wallet with RLS in this demo; wallet will be created on first topup webhook
        walletCoins = 0;
      }else{
        walletCoins = Number(w.coins || 0);
      }
      $("coins").textContent = walletCoins.toLocaleString();
      toast("Wallet refreshed");
    }
    window.refreshWallet = refreshWallet;

    // ===== Stripe topup =====
    async function topup(pack){
      const { data: s } = await supabase.auth.getSession();
      const token = s?.session?.access_token;
      if(!token){ toast("è¯·å…ˆ Login"); return; }

      toast("è·³è½¬åˆ°æ”¯ä»˜â€¦");
      const resp = await fetch("/api/create-checkout-session", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization": "Bearer "+token },
        body: JSON.stringify({ pack })
      });
      const j = await resp.json();
      if(!resp.ok){ toast(j?.error || "create session failed"); return; }
      location.href = j.url;
    }
    window.topup = topup;

    // ===== Game State =====
    const weaponTiers = [
      { name:"Rust Blade", base:2, hue:45 },
      { name:"Neon Saber", base:5, hue:200 },
      { name:"Plasma Katana", base:10, hue:270 },
      { name:"Goldfang", base:18, hue:45 },
      { name:"Void Reaper", base:28, hue:285 }
    ];

    let S = {
      level:1, xp:0, nextXp:40,
      hpMax:100, hp:100,
      dmgLv:1, spdLv:1, critLv:0,
      weaponLv:1,
      idle:false,
      enemyHpMax:80, enemyHp:80, enemyName:"Slime",
      fxPower:1
    };

    const cost = {
      dmg: ()=> Math.floor(12 + S.dmgLv*8),
      spd: ()=> Math.floor(18 + S.spdLv*10),
      crit:()=> Math.floor(24 + (S.critLv+1)*14),
      weap:()=> Math.floor(70 + (S.weaponLv-1)*85)
    };

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function stats(){
      const tier = weaponTiers[S.weaponLv-1] || weaponTiers[0];
      const base = tier.base;
      const dmg = base + (S.dmgLv-1)*2.4 + S.level*0.6;
      const spd = 1 + (S.spdLv-1)*0.12;
      const crit = clamp(0.05 + S.critLv*0.04, 0.05, 0.55);
      const critMul = 1.8 + (S.weaponLv-1)*0.15;
      const dps = dmg*spd*(1 + crit*(critMul-1));
      return { tier,dmg,spd,crit,critMul,dps };
    }

    function syncUI(){
      const st = stats();
      $("pLine").textContent = `Lv.${S.level} Â· HP ${S.hp}/${S.hpMax}`;
      $("eLine").textContent = `${S.enemyName} Â· HP ${Math.max(0,S.enemyHp)}/${S.enemyHpMax}`;
      $("pBar").style.width = `${Math.floor((S.hp/S.hpMax)*100)}%`;
      $("eBar").style.width = `${Math.floor((Math.max(0,S.enemyHp)/S.enemyHpMax)*100)}%`;
      $("weaponName").textContent = st.tier.name;
      $("wLv").textContent = S.weaponLv;
      $("cDmg").textContent = cost.dmg();
      $("cSpd").textContent = cost.spd();
      $("cCrit").textContent = cost.crit();
      $("cWeap").textContent = cost.weap();
      $("idleBtn").textContent = S.idle ? "ğŸ¤– Idle: ON" : "ğŸ¤– Idle: OFF";
    }

    // ===== FX Canvas =====
    const arena = document.getElementById("arena");
    const actx = arena.getContext("2d");
    const fx = document.getElementById("fx");
    const fctx = fx.getContext("2d");
    let w,h,dpr;
    function resize(){
      dpr = Math.max(1, Math.min(2, devicePixelRatio||1));
      w = arena.width = Math.floor(innerWidth*dpr);
      h = arena.height= Math.floor(innerHeight*dpr);
      arena.style.width = innerWidth+"px";
      arena.style.height= innerHeight+"px";
      fx.width = w; fx.height = h;
      fx.style.width = innerWidth+"px";
      fx.style.height = innerHeight+"px";
    }
    resize(); addEventListener("resize", resize);

    const P = { x: 0.30, y: 0.62, r: 30 };
    const E = { x: 0.70, y: 0.52, r: 34 };
    let parts=[], texts=[];
    let shake=0, flashA=0;
    function burst(x,y,hue,count,power){
      const n = Math.floor(count*power);
      for(let i=0;i<n;i++){
        parts.push({
          x,y,
          vx:(Math.random()*2-1)*(3.8+power*2.2)*dpr,
          vy:(Math.random()*-2-0.6)*(4.2+power*2.0)*dpr,
          s:(Math.random()*3.2+1.8)*dpr,
          a:1, h: hue+(Math.random()*30-15), rot:Math.random()*Math.PI,
          g:(0.10+Math.random()*0.10)*dpr
        });
      }
    }
    function dmgText(x,y,txt,hue,crit=false){
      texts.push({x,y,txt,hue,a:1,vy:(-1.5-Math.random()*0.6)*dpr,crit});
    }
    function shakeIt(p){ shake = Math.min(18*dpr, shake + p*6*dpr); }
    function flash(){ flashA = Math.min(1, flashA + 0.7); }

    // dash
    arena.addEventListener("pointerdown",(e)=>{
      burst((E.x*w), (E.y*h), 200, 40, 0.8);
      toast("Dash!");
    });

    // ===== Enemy/Progression =====
    function spawnEnemy(){
      const base = 70 + S.level*20;
      const hp = Math.floor(base*(1.05 + S.weaponLv*0.08));
      S.enemyHpMax = hp;
      S.enemyHp = hp;
      const names = ["Slime","Drone","Mimic","Golem","Warden","Specter","Titan"];
      S.enemyName = names[Math.min(names.length-1, Math.floor((S.level-1)/3))];
    }
    spawnEnemy();

    function gainXP(x){
      S.xp += x;
      while(S.xp >= S.nextXp){
        S.xp -= S.nextXp;
        S.level += 1;
        S.nextXp = Math.floor(S.nextXp*1.18 + 12);
        S.hpMax = Math.floor(S.hpMax*1.06 + 6);
        S.hp = S.hpMax;
        S.fxPower = Math.min(2.2, 1 + S.level*0.03);
        toast("LEVEL UP!");
        flash(); shakeIt(1.2);
      }
    }

    function onKill(){
      const reward = Math.floor(6 + S.level*2);
      walletCoins += reward;
      $("coins").textContent = walletCoins.toLocaleString();
      gainXP(Math.floor(12 + S.level*3));
      burst(E.x*w, E.y*h, 45, 90, S.fxPower);
      dmgText(E.x*w, E.y*h, `+${reward}`, 45, true);
      shakeIt(1.0);
      spawnEnemy();
    }

    function spendCoins(n){
      if(walletCoins < n) return false;
      walletCoins -= n;
      $("coins").textContent = walletCoins.toLocaleString();
      return true;
    }

    function hitEnemy(mult=1){
      const st = stats();
      const isCrit = Math.random() < st.crit;
      const dmg = (st.dmg*(isCrit?st.critMul:1))*mult;
      const dealt = Math.floor(dmg);
      S.enemyHp -= dealt;
      burst(E.x*w, E.y*h, st.tier.hue, isCrit?120:55, S.fxPower);
      dmgText(E.x*w, E.y*h, `-${dealt}`, st.tier.hue, isCrit);
      if(isCrit){ flash(); shakeIt(1.5); }
      else shakeIt(0.5);
      if(S.enemyHp <= 0) onKill();
    }

    // manual attack costs 1 coin
    function attackManual(){
      if(!spendCoins(1)){ toast("Coinsä¸è¶³ï¼Œå…ˆå……å€¼æˆ–æ‰“æ€ªèµš"); shakeIt(0.4); return; }
      hitEnemy(1);
      toast("âš”ï¸ Slash!");
    }
    window.attackManual = attackManual;

    let idleTimer=0;
    function toggleIdle(){
      S.idle = !S.idle;
      toast(S.idle ? "Idle ON" : "Idle OFF");
      syncUI();
    }
    window.toggleIdle = toggleIdle;

    function buy(type){
      const c = cost[type]();
      if(!spendCoins(c)){ toast("Coinsä¸è¶³"); shakeIt(0.4); return; }
      if(type==="dmg") S.dmgLv++;
      if(type==="spd") S.spdLv++;
      if(type==="crit") S.critLv++;
      if(type==="weap"){
        if(S.weaponLv >= weaponTiers.length){ toast("æ­¦å™¨å·²æ»¡çº§"); return; }
        S.weaponLv++;
        flash(); shakeIt(1.2);
      }
      burst(w*0.5, h*0.22, 200, 120, 1.2);
      toast("UPGRADED!");
      syncUI();
    }
    window.buy = buy;

    // ===== Background neon particles =====
    const fxPts = Array.from({length: Math.floor(Math.min(200, Math.max(120, innerWidth/7)))}).map(()=>({
      x:Math.random()*w,y:Math.random()*h,
      vx:(Math.random()*2-1)*0.26*dpr,
      vy:(Math.random()*2-1)*0.18*dpr,
      r:(Math.random()*2.2+0.8)*dpr,
      hh: Math.random()<0.33?45:(Math.random()<0.5?270:200),
      a: Math.random()*0.7+0.15
    }));

    function drawFighter(x,y,r,hue,isPlayer){
      const gg = actx.createRadialGradient(x,y,0,x,y,r*2.2);
      const c1 = isPlayer ? `hsla(${hue},90%,70%,0.30)` : `rgba(255,80,90,0.20)`;
      const c2 = isPlayer ? `hsla(${hue},90%,70%,0.02)` : `rgba(255,80,90,0.02)`;
      gg.addColorStop(0,c1); gg.addColorStop(1,c2);
      actx.fillStyle=gg; actx.beginPath(); actx.arc(x,y,r*2.2,0,Math.PI*2); actx.fill();

      actx.beginPath();
      actx.fillStyle = "rgba(255,255,255,0.10)";
      actx.strokeStyle = isPlayer ? `hsla(${hue},90%,70%,0.65)` : `rgba(255,120,120,0.55)`;
      actx.lineWidth = 2*dpr;
      actx.arc(x,y,r,0,Math.PI*2);
      actx.fill(); actx.stroke();
    }

    let last = performance.now();
    function loop(now){
      const dt = Math.min(0.05, (now-last)/1000);
      last = now;

      // idle attacks spend coin slowly
      if(S.idle){
        idleTimer += dt;
        const st = stats();
        const interval = 1 / Math.max(0.35, st.spd);
        while(idleTimer >= interval){
          idleTimer -= interval;
          if(!spendCoins(1)) { S.idle=false; toast("Coinsä¸è¶³ï¼ŒIdleåœæ­¢"); break; }
          hitEnemy(0.85);
        }
      }

      // FX bg
      fctx.clearRect(0,0,w,h);
      for(const p of fxPts){
        p.x+=p.vx; p.y+=p.vy;
        if(p.x<-60)p.x=w+60; if(p.x>w+60)p.x=-60;
        if(p.y<-60)p.y=h+60; if(p.y>h+60)p.y=-60;
        fctx.beginPath();
        fctx.fillStyle = `hsla(${p.hh},90%,70%,${p.a*0.22})`;
        fctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        fctx.fill();
      }
      if(flashA>0){
        fctx.fillStyle = `rgba(255,255,255,${flashA*0.12})`;
        fctx.fillRect(0,0,w,h);
        flashA *= 0.88;
      }

      // arena
      actx.clearRect(0,0,w,h);
      let sx=0, sy=0;
      if(shake>0){
        sx=(Math.random()*2-1)*shake; sy=(Math.random()*2-1)*shake;
        shake*=0.86; if(shake<0.2) shake=0;
      }
      actx.save(); actx.translate(sx,sy);

      const g = actx.createRadialGradient(w*0.5,h*0.72,0,w*0.5,h*0.72,Math.max(w,h)*0.55);
      g.addColorStop(0,"rgba(255,215,130,0.08)");
      g.addColorStop(0.35,"rgba(180,120,255,0.07)");
      g.addColorStop(0.7,"rgba(120,200,255,0.06)");
      g.addColorStop(1,"rgba(0,0,0,0)");
      actx.fillStyle=g; actx.fillRect(0,0,w,h);

      const st=stats();
      drawFighter(P.x*w, P.y*h, P.r*dpr, st.tier.hue, true);
      drawFighter(E.x*w, E.y*h, E.r*dpr, 0, false);

      for(let i=parts.length-1;i>=0;i--){
        const p=parts[i];
        p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.a*=0.985; p.rot+=0.12;
        actx.save();
        actx.translate(p.x,p.y); actx.rotate(p.rot);
        actx.fillStyle=`hsla(${p.h},90%,70%,${p.a})`;
        actx.fillRect(-p.s/2,-p.s/2,p.s,p.s*0.62);
        actx.restore();
        if(p.a<0.06 || p.y>h+80) parts.splice(i,1);
      }

      for(let i=texts.length-1;i>=0;i--){
        const t=texts[i];
        t.y+=t.vy; t.a*=0.97;
        actx.font = `${t.crit?(26*dpr):(18*dpr)}px Arial`;
        actx.fillStyle = `hsla(${t.hue},90%,70%,${t.a})`;
        actx.fillText(t.txt, t.x + (t.crit?-10*dpr:0), t.y);
        if(t.a<0.06) texts.splice(i,1);
      }

      actx.restore();
      syncUI();
      requestAnimationFrame(loop);
    }

    // start
    syncAccount();
    syncUI();
    requestAnimationFrame(loop);
  </script>
</body>
</html>
