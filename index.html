<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JKang Neon Arena</title>
  <meta name="description" content="JKang Neon Arena · A/B/C/D modes" />
  <style>
    :root{
      --bg:#070716;
      --text:#F6F7FF;
      --muted:rgba(255,255,255,.68);
      --line:rgba(255,255,255,.12);
      --good:#7CFFB5;
      --warn:#FFD27C;
      --danger:#FF6D8B;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.03);
      --shadow:0 32px 100px rgba(0,0,0,.55);
      --r:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 50% 0%, rgba(124,200,255,.14), transparent 60%),
        radial-gradient(900px 520px at 80% 80%, rgba(180,120,255,.10), transparent 60%),
        var(--bg);
      overflow:hidden;
    }
    a{color:inherit;text-decoration:none}
    canvas#fx{position:fixed;inset:0;width:100%;height:100%;z-index:0}
    canvas#game{position:fixed;inset:0;width:100%;height:100%;z-index:1;display:none}

    .wrap{position:relative;z-index:2;height:100%;display:flex;align-items:center;justify-content:center;padding:14px}
    .shell{
      width:min(1100px,94vw);
      border-radius:28px;
      border:1px solid var(--line);
      background:linear-gradient(to bottom, var(--card), var(--card2));
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .shell::before{
      content:"";position:absolute;inset:-2px;
      background:linear-gradient(135deg, rgba(124,200,255,.20), rgba(180,120,255,.16), transparent 72%);
      opacity:.35;pointer-events:none;
    }
    .topbar{
      position:relative;
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--line);
      backdrop-filter: blur(12px);
      background: linear-gradient(to bottom, rgba(7,7,22,.78), rgba(7,7,22,.25));
      gap:10px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:900;letter-spacing:.22em;text-transform:uppercase;font-size:13px;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2));
      box-shadow:0 0 24px rgba(124,200,255,.45);
    }
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      font-size:12px;color:var(--muted);
      display:flex;gap:8px;align-items:center;
      user-select:none;
    }
    .pill b{color:var(--text)}
    .btn{
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);cursor:pointer;font-weight:900;font-size:13px;
      transition:.18s ease; user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    .btn.primary{background:#fff;color:#000;border-color:transparent}
    .btn.danger{border-color:rgba(255,109,139,.35); background:rgba(255,109,139,.10)}
    .btn.good{border-color:rgba(124,255,181,.35); background:rgba(124,255,181,.10)}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}

    .content{position:relative;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.35fr .65fr}}

    .panel{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:rgba(0,0,0,.22);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .panel h2{margin:0 0 6px;font-size:12px;letter-spacing:.16em;text-transform:uppercase;color:rgba(255,255,255,.78)}
    .panel p{margin:0;color:var(--muted);line-height:1.75;font-size:13px}
    .sep{height:1px;background:var(--line);margin:12px 0}

    .modes{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    @media(min-width:700px){.modes{grid-template-columns:1fr 1fr}}

    .mode{
      border:1px solid var(--line);
      border-radius:18px;
      background: linear-gradient(to bottom, rgba(255,255,255,.07), rgba(255,255,255,.02));
      padding:12px;
      cursor:pointer;
      transition:.18s ease;
      position:relative;
      overflow:hidden;
      min-height:96px;
    }
    .mode::after{
      content:"";position:absolute;inset:-2px;
      background: radial-gradient(340px 170px at var(--mx,50%) var(--my,50%),
        rgba(124,200,255,.18), rgba(180,120,255,.12), transparent 60%);
      opacity:0;transition:.18s ease;pointer-events:none;
    }
    .mode:hover::after{opacity:1}
    .mode:hover{transform:translateY(-2px)}
    .mode .t{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge{
      font-weight:900;font-size:12px;letter-spacing:.18em;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid var(--line);
    }
    .mode h3{margin:10px 0 6px;font-size:18px}
    .mode small{color:var(--muted);line-height:1.5;display:block}

    .overlay{
      position:fixed;inset:0;z-index:5;
      display:flex;align-items:center;justify-content:center;
      background:rgba(5,6,16,.74);
      backdrop-filter: blur(12px);
    }
    .loginBox{
      width:min(560px,92vw);
      border:1px solid var(--line);
      border-radius:28px;
      background: linear-gradient(to bottom, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .loginBox::before{
      content:"";position:absolute;inset:-2px;
      background:
        radial-gradient(520px 240px at 20% 20%, rgba(124,200,255,.20), transparent 60%),
        radial-gradient(520px 240px at 80% 80%, rgba(180,120,255,.16), transparent 60%);
      opacity:.85;pointer-events:none;
    }
    .loginInner{position:relative}
    .title{margin:0 0 6px;font-size:20px;letter-spacing:.14em}
    .sub{margin:0 0 14px;color:var(--muted);line-height:1.7;font-size:13px}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .msg{margin-top:10px;color:rgba(255,255,255,.86);font-size:13px;white-space:pre-wrap}
    .tiny{margin-top:10px;color:rgba(255,255,255,.55);font-size:12px;line-height:1.6}
    .tiny b{color:rgba(255,255,255,.88)}

    .hud{
      position:fixed;left:14px;right:14px;bottom:14px;z-index:4;
      border:1px solid var(--line);
      border-radius:26px;
      background:rgba(0,0,0,.34);
      backdrop-filter: blur(10px);
      padding:12px;
      display:none;
    }
    .hudTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .hudTitle{font-weight:900;letter-spacing:.16em;text-transform:uppercase;font-size:12px;color:rgba(255,255,255,.82)}
    .hudDesc{color:rgba(255,255,255,.68);font-size:12px;line-height:1.5;margin-top:4px}
    .hudBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    .flash{
      position:fixed;inset:0;z-index:3;
      pointer-events:none;
      background:radial-gradient(800px 400px at 50% 50%, rgba(255,255,255,.10), transparent 60%);
      opacity:0;
      transition:.12s ease;
    }
    .flash.on{opacity:1}
    @keyframes shake{
      0%,100%{transform:translate(0,0)}
      20%{transform:translate(-2px,1px)}
      40%{transform:translate(2px,-1px)}
      60%{transform:translate(-1px,-2px)}
      80%{transform:translate(1px,2px)}
    }
    .shake{animation:shake .18s linear 1}
    .toast{
      position:fixed;top:14px;left:50%;transform:translateX(-50%);
      z-index:6;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      color:rgba(255,255,255,.86);
      font-size:12px;
      opacity:0;pointer-events:none;
      transition:.2s ease;
      max-width:min(92vw,680px);
      white-space:pre-wrap;
      text-align:center;
    }
    .toast.show{opacity:1}
  </style>
</head>

<body>
  <canvas id="fx"></canvas>
  <canvas id="game"></canvas>
  <div class="flash" id="flash"></div>
  <div class="toast" id="toast"></div>

  <div class="overlay" id="login">
    <div class="loginBox">
      <div class="loginInner">
        <h1 class="title">LOGIN → ENTER ARENA</h1>
        <p class="sub">
          这是 <b>娱乐型</b> 游戏站：金币/宝石仅用于游戏玩法，<b>不提供提现</b>。<br/>
          Email OTP 登录后直接进入动画游戏大厅。
        </p>
        <input id="email" type="email" placeholder="you@example.com" />
        <div class="row">
          <button class="btn primary" id="otpBtn">Send Login Link</button>
          <button class="btn" id="demoBtn">Demo（Guest）</button>
        </div>
        <div class="msg" id="loginMsg"></div>
        <div class="tiny">
          如果你没收到邮件：Supabase → Authentication → URL Configuration<br/>
          <b>Site URL</b>=你的域名，<b>Redirect URLs</b>=<b>https://你的域名/*</b>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="shell" id="app">
      <div class="topbar">
        <div class="brand"><span class="dot"></span> JKANG NEON ARENA</div>
        <div class="right">
          <div class="pill">Account: <b id="acct">Guest</b></div>
          <div class="pill">Coins: <b id="coins">0</b></div>
          <div class="pill">Gems: <b id="gems">0</b></div>
          <div class="pill">Weapon Lv: <b id="wlv">1</b></div>
          <button class="btn good" id="topupBtn">Recharge</button>
          <button class="btn danger" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="content" id="lobby">
        <div class="grid">
          <div class="panel">
            <h2>Lobby</h2>
            <p>进入就是动画：爆炸、粒子、闪光、抖屏。A/B/C/D 都能玩。</p>
            <div class="sep"></div>

            <div class="modes">
              <div class="mode" data-mode="A">
                <div class="t"><div class="badge">A</div><div class="badge" style="opacity:.75">DUEL</div></div>
                <h3>对战 Arena</h3>
                <small>横版对打 · AI 敌人 · 技能爆炸 + 抖屏</small>
              </div>

              <div class="mode" data-mode="B">
                <div class="t"><div class="badge">B</div><div class="badge" style="opacity:.75">AFK</div></div>
                <h3>挂机 Dungeon</h3>
                <small>自动打怪 · 掉金币动画 · 持续收益</small>
              </div>

              <div class="mode" data-mode="C">
                <div class="t"><div class="badge">C</div><div class="badge" style="opacity:.75">FORGE</div></div>
                <h3>武器强化</h3>
                <small>升级武器 · 提升伤害 · 消耗金币</small>
              </div>

              <div class="mode" data-mode="D">
                <div class="t"><div class="badge">D</div><div class="badge" style="opacity:.75">RANK</div></div>
                <h3>排行榜</h3>
                <small>读取 wallets 金币榜（公开只读）</small>
              </div>
            </div>

            <div class="sep"></div>
            <p style="color:rgba(255,255,255,.62);font-size:12px;line-height:1.7">
              充值说明：Recharge 只是跳转支付链接。要做到“支付成功自动加币”，需要 Stripe Webhook（之后我一步一步带你做）。
            </p>
          </div>

          <div class="panel">
            <h2>Status</h2>
            <p id="status">加载中…</p>
            <div class="sep"></div>
            <p style="font-size:12px;color:rgba(255,255,255,.62);line-height:1.7">
              若你想“后台可控”：下一步加 Admin 面板（仅你账号可见）来发币/改数值/封禁。
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="hud" id="hud">
    <div class="hudTop">
      <div>
        <div class="hudTitle" id="hudTitle">MODE</div>
        <div class="hudDesc" id="hudDesc">…</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn small" id="backBtn">Back to Lobby</button>
        <button class="btn small" id="actionBtn">Action</button>
      </div>
    </div>
    <div class="hudBtns" id="hudBtns"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /*********************
     * ✅ 你只改这三项
     *********************/
    const SUPABASE_URL = "https://zrulbxnqtliyxycfjgks.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_4kcgAmTjO0pFPCxqyZ-1gw_vOuUx8SP";
    const STRIPE_TOPUP_URL = "https://buy.stripe.com/REPLACE_ME";

    /*********************/
    const $ = (id)=>document.getElementById(id);
    const toastEl = $("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 2200);
    }
    function fmt(n){ return Number(n||0).toLocaleString(); }
    function setStatus(t){ $("status").textContent = t; }

    window.addEventListener("mousemove",(e)=>{
      document.documentElement.style.setProperty("--mx", e.clientX+"px");
      document.documentElement.style.setProperty("--my", e.clientY+"px");
    }, {passive:true});

    /*********************
     * SUPABASE
     *********************/
    let supabase = null;
    let sessionUser = null;
    let isGuest = false;

    let wallet = { coins:0, gems:0 };
    let weapon = { weapon_level:1, weapon_power:10 };

    function setUIUser(name){ $("acct").textContent = name || "Guest"; }
    function setUIStats(){
      $("coins").textContent = fmt(wallet.coins);
      $("gems").textContent  = fmt(wallet.gems);
      $("wlv").textContent   = String(weapon.weapon_level||1);
    }

    async function initPlayerRows(userId){
      await supabase.from("wallets").upsert({ user_id: userId }, { onConflict: "user_id" });
      await supabase.from("weapons").upsert({ user_id: userId }, { onConflict: "user_id" });
    }

    async function loadPlayerState(){
      if(isGuest){
        const s = JSON.parse(localStorage.getItem("jkang_guest")||"{}");
        wallet.coins = s.coins ?? 120;
        wallet.gems  = s.gems  ?? 0;
        weapon.weapon_level = s.wlv ?? 1;
        weapon.weapon_power = s.wp  ?? (10 + (weapon.weapon_level-1)*4);
        setUIStats();
        setStatus("Guest 模式：数据保存在本机（localStorage）。");
        return;
      }

      const userId = sessionUser.id;
      await initPlayerRows(userId);

      const { data: w, error: we } = await supabase.from("wallets").select("coins,gems").eq("user_id", userId).single();
      if(we){ console.log(we); toast("读取钱包失败"); }
      wallet.coins = w?.coins ?? 0;
      wallet.gems  = w?.gems  ?? 0;

      const { data: wp, error: wpe } = await supabase.from("weapons").select("weapon_level,weapon_power").eq("user_id", userId).single();
      if(wpe){ console.log(wpe); toast("读取武器失败"); }
      weapon.weapon_level = wp?.weapon_level ?? 1;
      weapon.weapon_power = wp?.weapon_power ?? (10 + (weapon.weapon_level-1)*4);

      setUIStats();
      setStatus("已登录：数据来自 Supabase（wallets / weapons）。");
    }

    async function saveGuest(){
      localStorage.setItem("jkang_guest", JSON.stringify({
        coins: wallet.coins, gems: wallet.gems,
        wlv: weapon.weapon_level, wp: weapon.weapon_power
      }));
    }

    async function log(mode, detail){
      if(isGuest) return;
      await supabase.from("game_logs").insert({ user_id: sessionUser.id, mode, detail });
    }

    async function addCoins(amount, mode, detail={}){
      amount = Math.max(0, Math.floor(amount));
      wallet.coins += amount;
      setUIStats();

      if(isGuest){
        await saveGuest();
        return;
      }
      await supabase.from("wallets").update({ coins: wallet.coins, updated_at: new Date().toISOString() }).eq("user_id", sessionUser.id);
      await log(mode, detail);
    }

    async function spendCoins(amount){
      amount = Math.max(0, Math.floor(amount));
      if(wallet.coins < amount) return false;
      wallet.coins -= amount;
      setUIStats();

      if(isGuest){ await saveGuest(); return true; }
      await supabase.from("wallets").update({ coins: wallet.coins, updated_at: new Date().toISOString() }).eq("user_id", sessionUser.id);
      return true;
    }

    async function upgradeWeapon(){
      const lvl = weapon.weapon_level || 1;
      const cost = Math.floor(80 + (lvl-1)*60);
      if(!(await spendCoins(cost))){
        toast("金币不足：去挂机/对战赚金币，或 Recharge。");
        return;
      }
      weapon.weapon_level = lvl + 1;
      weapon.weapon_power = Math.floor(10 + (weapon.weapon_level-1)*4);
      setUIStats();
      toast(`升级成功！Weapon Lv ${weapon.weapon_level}`);

      if(isGuest){ await saveGuest(); return; }
      await supabase.from("weapons").update({
        weapon_level: weapon.weapon_level,
        weapon_power: weapon.weapon_power,
        upgraded_at: new Date().toISOString()
      }).eq("user_id", sessionUser.id);
      await log("C", { action:"upgrade", level: weapon.weapon_level, power: weapon.weapon_power, cost });
    }

    /*********************
     * CANVAS FX + GAME
     *********************/
    const fx = $("fx"), fctx = fx.getContext("2d");
    const g  = $("game"), ctx = g.getContext("2d");
    const flash = $("flash");

    let W=0,H=0,DPR=1;
    function resize(){
      DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
      W = fx.width = g.width = Math.floor(innerWidth*DPR);
      H = fx.height= g.height= Math.floor(innerHeight*DPR);
      fx.style.width = g.style.width = innerWidth+"px";
      fx.style.height= g.style.height= innerHeight+"px";
    }
    addEventListener("resize", resize); resize();

    const P=[];
    function seedParticles(){
      P.length=0;
      const n = Math.floor((innerWidth*innerHeight)/15000)+90;
      for(let i=0;i<n;i++){
        P.push({
          x:Math.random()*W, y:Math.random()*H,
          r:(Math.random()*1.8+.3)*DPR,
          vx:(Math.random()-.5)*0.14*DPR,
          vy:(Math.random()-.2)*0.42*DPR,
          a:Math.random()*0.7+0.15,
          h:(Math.random()<0.5?200:285)
        });
      }
    }
    seedParticles();

    function drawFX(){
      fctx.clearRect(0,0,W,H);
      const grd = fctx.createRadialGradient(W/2,H/2,0,W/2,H/2,Math.max(W,H)*0.55);
      grd.addColorStop(0,"rgba(255,255,255,0.03)");
      grd.addColorStop(1,"rgba(0,0,0,0)");
      fctx.fillStyle = grd;
      fctx.fillRect(0,0,W,H);

      for(const p of P){
        p.x += p.vx; p.y += p.vy;
        if(p.y > H+10){ p.y=-10; p.x=Math.random()*W; }
        if(p.x < -10) p.x = W+10;
        if(p.x > W+10) p.x = -10;
        fctx.beginPath();
        fctx.fillStyle = `hsla(${p.h}, 95%, 70%, ${p.a})`;
        fctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        fctx.fill();
      }
    }

    const FXE=[];
    function boom(x,y,power=1){
      flash.classList.add("on");
      setTimeout(()=>flash.classList.remove("on"), 80);
      document.body.classList.remove("shake");
      void document.body.offsetWidth;
      document.body.classList.add("shake");

      const n = Math.floor(22 + power*16);
      for(let i=0;i<n;i++){
        FXE.push({
          x,y,
          vx:(Math.random()-.5)*(3.8+power*2.2)*DPR,
          vy:(Math.random()-.5)*(3.8+power*2.2)*DPR,
          life: 34+Math.random()*22,
          r:(Math.random()*2.4+1.2)*DPR,
          hue: (Math.random()<0.5)? 200 : 285
        });
      }
    }
    function drawExplosions(){
      for(let i=FXE.length-1;i>=0;i--){
        const e=FXE[i];
        e.life -= 1;
        e.x += e.vx; e.y += e.vy;
        e.vx *= 0.98; e.vy *= 0.98;
        e.vy += 0.05*DPR;
        const a = Math.max(0, Math.min(1, e.life/42));
        ctx.beginPath();
        ctx.fillStyle = `hsla(${e.hue}, 95%, 70%, ${a})`;
        ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
        ctx.fill();
        if(e.life<=0) FXE.splice(i,1);
      }
    }

    function neonRect(x,y,w,h,alpha=1){
      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.fillRect(x,y,w,h);
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      ctx.strokeRect(x,y,w,h);
      ctx.restore();
    }

    // Modes
    let mode = "LOBBY";
    let running = false;

    // A: Duel (简化对打：左右移动 + 释放技能打 AI)
    const duel = {
      player:{ x:0, y:0, vx:0, hp:100 },
      enemy:{ x:0, y:0, vx:0, hp:100 },
      bullets:[],
      cooldown:0,
      coinsEarned:0
    };

    // B: AFK (自动刷怪 + 掉金币动画)
    const afk = {
      t:0,
      tick:0,
      coinsEarned:0
    };

    // input
    const keys = {};
    addEventListener("keydown",(e)=>{ keys[e.key.toLowerCase()] = true; });
    addEventListener("keyup",(e)=>{ keys[e.key.toLowerCase()] = false; });

    function startMode(m){
      mode = m;
      $("hud").style.display = "block";
      $("game").style.display = "block";
      $("lobby").style.display = "none";
      running = true;

      if(m==="A"){
        $("hudTitle").textContent="MODE A · DUEL";
        $("hudDesc").textContent="WASD/方向键移动，空格释放技能。击败 AI 掉金币。";
        $("actionBtn").textContent="Skill (Space)";
        duel.player = { x:W*0.30, y:H*0.60, vx:0, hp:100 };
        duel.enemy  = { x:W*0.70, y:H*0.60, vx:0, hp:100 };
        duel.bullets = [];
        duel.cooldown=0;
        duel.coinsEarned=0;
        toast("进入对战！");
      }

      if(m==="B"){
        $("hudTitle").textContent="MODE B · AFK";
        $("hudDesc").textContent="自动刷怪，每几秒掉金币。你可以挂机看动画。";
        $("actionBtn").textContent="Boost";
        afk.t=0; afk.tick=0; afk.coinsEarned=0;
        toast("进入挂机！");
      }

      if(m==="C"){
        $("hudTitle").textContent="MODE C · FORGE";
        $("hudDesc").textContent="消耗金币强化武器，提高伤害与收益。";
        $("actionBtn").textContent="Upgrade";
        toast("进入锻造！");
      }

      if(m==="D"){
        $("hudTitle").textContent="MODE D · RANK";
        $("hudDesc").textContent="读取 wallets 金币排行榜（公开只读）。";
        $("actionBtn").textContent="Refresh";
        toast("进入排行榜！");
        renderRank();
      }
    }

    function backToLobby(){
      mode="LOBBY";
      running=false;
      $("hud").style.display="none";
      $("game").style.display="none";
      $("lobby").style.display="block";
      ctx.clearRect(0,0,W,H);
      toast("回到大厅");
    }

    $("backBtn").addEventListener("click", backToLobby);

    $("actionBtn").addEventListener("click", async ()=>{
      if(mode==="A"){
        fireSkill();
      }else if(mode==="B"){
        // boost：直接爆炸一下 + 奖励少量金币
        boom(W*0.5, H*0.45, 1.1);
        await addCoins(5, "B", { action:"boost" });
        afk.coinsEarned += 5;
        toast("+5 coins");
      }else if(mode==="C"){
        await upgradeWeapon();
      }else if(mode==="D"){
        await renderRank(true);
      }
    });

    function fireSkill(){
      if(duel.cooldown>0) return;
      duel.cooldown = 26;
      const dx = (duel.enemy.x - duel.player.x);
      const dir = dx>=0 ? 1 : -1;
      duel.bullets.push({
        x: duel.player.x + dir*32*DPR,
        y: duel.player.y - 12*DPR,
        vx: dir*(8.5 + weapon.weapon_level*0.25)*DPR,
        life: 90,
        dmg: Math.floor(8 + weapon.weapon_level*2.2)
      });
      boom(duel.player.x, duel.player.y-10*DPR, 0.75);
    }

    function updateDuel(){
      // move
      const left  = keys["a"] || keys["arrowleft"];
      const right = keys["d"] || keys["arrowright"];
      const up    = keys["w"] || keys["arrowup"];
      const down  = keys["s"] || keys["arrowdown"];
      const spc   = keys[" "] || keys["space"];

      const speed = 4.2*DPR;
      duel.player.vx = (right?1:0) - (left?1:0);
      let vy = (down?1:0) - (up?1:0);
      duel.player.x += duel.player.vx*speed;
      duel.player.y += vy*speed;

      duel.player.x = Math.max(60*DPR, Math.min(W-60*DPR, duel.player.x));
      duel.player.y = Math.max(120*DPR, Math.min(H-90*DPR, duel.player.y));

      if(spc) fireSkill();
      if(duel.cooldown>0) duel.cooldown--;

      // enemy AI
      const targetX = duel.player.x + (Math.sin(Date.now()/500)*120*DPR);
      duel.enemy.x += Math.sign(targetX - duel.enemy.x) * (2.6*DPR);
      duel.enemy.y += Math.sin(Date.now()/420) * (0.8*DPR);

      // bullets
      for(let i=duel.bullets.length-1;i>=0;i--){
        const b = duel.bullets[i];
        b.life--;
        b.x += b.vx;
        // hit enemy
        const dx = b.x - duel.enemy.x;
        const dy = b.y - duel.enemy.y;
        if(dx*dx+dy*dy < (48*DPR)*(48*DPR)){
          duel.enemy.hp -= b.dmg;
          boom(b.x,b.y,1.25);
          duel.bullets.splice(i,1);
          if(duel.enemy.hp<=0){
            // respawn enemy + reward
            duel.enemy.hp = 100 + weapon.weapon_level*8;
            duel.enemy.x = W*(0.62 + Math.random()*0.28);
            duel.enemy.y = H*(0.40 + Math.random()*0.30);
            const reward = Math.floor(18 + weapon.weapon_level*4);
            duel.coinsEarned += reward;
            addCoins(reward, "A", { action:"kill", reward, wlv: weapon.weapon_level });
            toast(`击败敌人 +${reward} coins`);
            boom(duel.enemy.x, duel.enemy.y, 1.6);
          }
        }
        if(b.life<=0 || b.x<-50 || b.x>W+50) duel.bullets.splice(i,1);
      }
    }

    function drawDuel(){
      ctx.clearRect(0,0,W,H);
      // arena floor
      neonRect(70*DPR, 120*DPR, W-140*DPR, H-210*DPR, 1);
      // player
      drawFighter(duel.player.x, duel.player.y, 200, duel.player.hp/140);
      // enemy
      drawFighter(duel.enemy.x, duel.enemy.y, 285, duel.enemy.hp/160);
      // bullets
      for(const b of duel.bullets){
        ctx.beginPath();
        ctx.fillStyle="rgba(255,255,255,.9)";
        ctx.arc(b.x,b.y,3.5*DPR,0,Math.PI*2);
        ctx.fill();
      }
      drawExplosions();
      drawHUDText(`Coins Earned: ${duel.coinsEarned}`);
    }

    function drawFighter(x,y,hue,hpPct){
      // glow
      ctx.save();
      ctx.shadowColor = `hsla(${hue}, 95%, 70%, 0.9)`;
      ctx.shadowBlur = 24*DPR;
      ctx.fillStyle = `hsla(${hue}, 95%, 60%, 0.55)`;
      ctx.beginPath();
      ctx.arc(x,y,26*DPR,0,Math.PI*2);
      ctx.fill();
      ctx.restore();

      // core
      ctx.fillStyle = `hsla(${hue}, 95%, 70%, 0.9)`;
      ctx.beginPath();
      ctx.arc(x,y,10*DPR,0,Math.PI*2);
      ctx.fill();

      // hp bar
      const w = 90*DPR, h=10*DPR;
      ctx.fillStyle="rgba(0,0,0,.35)";
      ctx.fillRect(x-w/2,y-48*DPR,w,h);
      ctx.fillStyle=`hsla(${hue},95%,70%,.9)`;
      ctx.fillRect(x-w/2,y-48*DPR,Math.max(0,Math.min(1,hpPct))*w,h);
      ctx.strokeStyle="rgba(255,255,255,.18)";
      ctx.strokeRect(x-w/2,y-48*DPR,w,h);
    }

    function drawHUDText(t){
      ctx.save();
      ctx.font = `${12*DPR}px Arial`;
      ctx.fillStyle = "rgba(255,255,255,.75)";
      ctx.fillText(t, 24*DPR, 34*DPR);
      ctx.restore();
    }

    function updateAFK(){
      afk.t += 1;
      // 每 120 帧（约2秒）奖励一次
      if(afk.t % 120 === 0){
        const reward = Math.floor(8 + weapon.weapon_level*2);
        afk.coinsEarned += reward;
        addCoins(reward, "B", { action:"tick", reward, wlv: weapon.weapon_level });
        // 大爆炸动画
        boom(W*(0.35+Math.random()*0.30), H*(0.35+Math.random()*0.30), 1.4);
        toast(`挂机收益 +${reward} coins`);
      }
    }

    function drawAFK(){
      ctx.clearRect(0,0,W,H);
      // dungeon frame
      neonRect(70*DPR, 120*DPR, W-140*DPR, H-210*DPR, 1);
      // animated portals
      const t = Date.now()/500;
      for(let i=0;i<5;i++){
        const x = (W*(0.2+i*0.16));
        const y = H*(0.55 + Math.sin(t+i)*0.08);
        const hue = (i%2?200:285);
        ctx.save();
        ctx.shadowColor = `hsla(${hue},95%,70%,.9)`;
        ctx.shadowBlur = 26*DPR;
        ctx.strokeStyle = `hsla(${hue},95%,70%,.65)`;
        ctx.lineWidth = 3*DPR;
        ctx.beginPath();
        ctx.arc(x,y,18*DPR + (Math.sin(t*2+i)*4*DPR),0,Math.PI*2);
        ctx.stroke();
        ctx.restore();
      }
      drawExplosions();
      drawHUDText(`AFK Coins Earned: ${afk.coinsEarned}`);
    }

    async function renderRank(showToast=false){
      if(isGuest){
        setStatus("Guest 模式不读取排行榜。请登录后再看。");
        if(showToast) toast("请登录后查看排行榜");
        return;
      }
      const { data, error } = await supabase
        .from("wallets")
        .select("user_id, coins")
        .order("coins", { ascending:false })
        .limit(10);

      if(error){
        console.log(error);
        setStatus("排行榜读取失败：检查 wallets_public_read policy 是否存在。");
        if(showToast) toast("排行榜失败");
        return;
      }

      const lines = data.map((r,i)=>`${String(i+1).padStart(2,"0")}  ·  ${r.user_id.slice(0,6)}…  ·  ${fmt(r.coins)} coins`);
      setStatus("Top 10 Coins\n" + lines.join("\n"));
      if(showToast) toast("排行榜已刷新");
    }

    function updateForge(){
      // 纯展示：画一个锻造能量环
    }
    function drawForge(){
      ctx.clearRect(0,0,W,H);
      neonRect(70*DPR, 120*DPR, W-140*DPR, H-210*DPR, 1);
      const t = Date.now()/600;
      const x=W/2, y=H/2;
      for(let i=0;i<3;i++){
        const hue = i%2?200:285;
        ctx.save();
        ctx.shadowColor = `hsla(${hue},95%,70%,.9)`;
        ctx.shadowBlur = 30*DPR;
        ctx.strokeStyle = `hsla(${hue},95%,70%,.55)`;
        ctx.lineWidth = 4*DPR;
        ctx.beginPath();
        ctx.arc(x,y, 46*DPR + i*22*DPR + Math.sin(t+i)*6*DPR, 0, Math.PI*2);
        ctx.stroke();
        ctx.restore();
      }
      ctx.save();
      ctx.font = `${16*DPR}px Arial`;
      ctx.fillStyle="rgba(255,255,255,.78)";
      ctx.fillText(`Upgrade Cost: ${fmt(Math.floor(80 + (weapon.weapon_level-1)*60))} coins`, x-120*DPR, y+90*DPR);
      ctx.restore();
      drawExplosions();
      drawHUDText(`Weapon Lv: ${weapon.weapon_level}  Power: ${weapon.weapon_power}`);
    }

    function updateRank(){}
    function drawRank(){
      ctx.clearRect(0,0,W,H);
      neonRect(70*DPR, 120*DPR, W-140*DPR, H-210*DPR, 1);
      drawExplosions();
      drawHUDText("Rank is shown in Status panel → right side");
    }

    function loop(){
      requestAnimationFrame(loop);
      drawFX();

      if(!running) return;

      if(mode==="A"){ updateDuel(); drawDuel(); }
      if(mode==="B"){ updateAFK(); drawAFK(); }
      if(mode==="C"){ updateForge(); drawForge(); }
      if(mode==="D"){ updateRank(); drawRank(); }
    }
    loop();

    /*********************
     * UI EVENTS
     *********************/
    document.querySelectorAll(".mode").forEach(el=>{
      el.addEventListener("click", ()=> startMode(el.dataset.mode));
    });

    $("topupBtn").addEventListener("click", ()=>{
      window.open(STRIPE_TOPUP_URL, "_blank", "noopener");
    });

    $("logoutBtn").addEventListener("click", async ()=>{
      if(isGuest){
        isGuest=false;
        backToLobby();
        $("login").style.display="flex";
        setUIUser("Guest");
        wallet={coins:0,gems:0}; weapon={weapon_level:1,weapon_power:10}; setUIStats();
        setStatus("已退出 Guest。");
        return;
      }
      await supabase.auth.signOut();
      sessionUser=null;
      backToLobby();
      $("login").style.display="flex";
      setUIUser("Guest");
      wallet={coins:0,gems:0}; weapon={weapon_level:1,weapon_power:10}; setUIStats();
      setStatus("已退出登录。");
    });

    $("demoBtn").addEventListener("click", async ()=>{
      isGuest = true;
      $("login").style.display="none";
      setUIUser("Guest");
      await loadPlayerState();
      toast("Guest 模式进入");
    });

    $("otpBtn").addEventListener("click", async ()=>{
      const email = $("email").value.trim();
      if(!email){ $("loginMsg").textContent="请输入邮箱"; return; }
      $("loginMsg").textContent="发送中…";

      try{
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options:{
            // 登录成功后回到你的网站（必须在 Redirect URLs 允许）
            emailRedirectTo: window.location.origin + window.location.pathname
          }
        });
        if(error){
          console.log(error);
          $("loginMsg").textContent = "发送失败：\n" + error.message;
          return;
        }
        $("loginMsg").textContent = "已发送登录链接到邮箱。\n打开邮件点击链接即可进入游戏。";
      }catch(e){
        console.log(e);
        $("loginMsg").textContent = "发送异常：" + String(e);
      }
    });

    /*********************
     * INIT
     *********************/
    async function boot(){
      // 防止你忘记填
      if(!SUPABASE_URL.includes("http") || SUPABASE_ANON_KEY.includes("PASTE_")){
        setStatus("请先在 index.html 填入 SUPABASE_URL 与 SUPABASE_ANON_KEY，然后重新部署。");
        $("loginMsg").textContent = "⚠️ 你还没填 Supabase URL / ANON KEY。";
        return;
      }

      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      setStatus("Supabase 已连接。等待登录…");

      // 如果是从邮件跳回来的，会自动有 session
      const { data } = await supabase.auth.getUser();
      sessionUser = data?.user || null;

      if(sessionUser){
        $("login").style.display="none";
        isGuest=false;
        setUIUser(sessionUser.email || "Player");
        await loadPlayerState();
        toast("登录成功，进入大厅");
      }else{
        $("login").style.display="flex";
        setUIUser("Guest");
        setUIStats();
        setStatus("请登录或使用 Guest Demo。");
      }

      supabase.auth.onAuthStateChange(async (event, session)=>{
        if(event==="SIGNED_IN" && session?.user){
          sessionUser = session.user;
          isGuest=false;
          $("login").style.display="none";
          setUIUser(sessionUser.email || "Player");
          await loadPlayerState();
          toast("已登录");
        }
      });
    }
    boot();
  </script>
</body>
</html>
