<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>JKang Market FINAL</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{font-family:Arial;background:#0f172a;color:#fff;padding:20px}
button{padding:10px;margin:5px;border-radius:6px;border:none;cursor:pointer}
.primary{background:#fff;color:#000}
.card{background:#1e293b;padding:15px;border-radius:10px;margin-top:20px}
input{padding:10px;width:100%;margin-top:10px;border-radius:6px;border:none}
#log{background:#000;padding:10px;margin-top:10px;height:150px;overflow:auto;font-size:12px}
</style>
</head>
<body>

<h2>JKang Market FINAL</h2>

<div class="card">
<button id="btnTest" class="primary">点我测试</button>
<button id="btnPing">Ping Supabase</button>
<div id="origin"></div>
</div>

<div class="card">
<input id="email" placeholder="输入邮箱登录">
<button id="btnLogin" class="primary">Send Magic Link</button>
<button id="btnLogout">Logout</button>
<div id="auth"></div>
</div>

<div class="card">
<button id="btnSeller">Become Seller</button>
<button id="btnAdd">Add Product</button>
<button id="btnLoad" class="primary">Load Products</button>
<div id="products"></div>
</div>

<div class="card">
<div id="log"></div>
</div>

<script>

const SUPABASE_URL = "https://zdfoelcwmmbvwtjhfixv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkZm9lbGN3bW1idnd0amhmaXh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MzAzNjEsImV4cCI6MjA4NzMwNjM2MX0.Ije9hEA0q4NFnQlThh75BV-MQ0Ph95MFTss3FO2ANWc";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const log = (m)=>{ 
  document.getElementById("log").innerHTML += m+"<br>";
};

document.getElementById("origin").innerText = "Origin: " + location.origin;

document.getElementById("btnTest").onclick = ()=> {
  alert("按钮正常");
  log("按钮点击正常");
};

document.getElementById("btnPing").onclick = async ()=> {
  try{
    const r = await fetch(SUPABASE_URL + "/rest/v1/");
    log("Ping 状态: "+r.status);
  }catch(e){
    log("Ping 错误: "+e.message);
  }
};

document.getElementById("btnLogin").onclick = async ()=> {
  const email = document.getElementById("email").value;
  if(!email){ alert("输入邮箱"); return; }

  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: location.origin }
  });

  if(error){
    log("登录失败: "+error.message);
  }else{
    log("Magic link 已发送");
  }
};

document.getElementById("btnLogout").onclick = async ()=> {
  const { error } = await supabase.auth.signOut();
  if(error){
    log("退出失败: "+error.message);
  }else{
    log("已退出");
  }
};

document.getElementById("btnSeller").onclick = async ()=>{
  const { data:session } = await supabase.auth.getSession();
  if(!session.session){ log("未登录"); return; }

  const user = session.session.user;

  const { error } = await supabase
    .from("sellers")
    .upsert({ user_id:user.id, shop_name:"My Shop" });

  if(error) log("创建卖家失败: "+error.message);
  else log("卖家创建成功");
};

document.getElementById("btnAdd").onclick = async ()=>{
  const { data:session } = await supabase.auth.getSession();
  if(!session.session){ log("未登录"); return; }

  const user = session.session.user;

  const { error } = await supabase
    .from("products")
    .insert({
      seller_user_id:user.id,
      title:"Test Product",
      price_cents:999,
      stock:10
    });

  if(error) log("添加商品失败: "+error.message);
  else log("商品添加成功");
};

document.getElementById("btnLoad").onclick = async ()=>{
  const { data,error } = await supabase
    .from("products")
    .select("*")
    .order("created_at",{ascending:false});

  if(error){
    log("加载失败: "+error.message);
    return;
  }

  document.getElementById("products").innerHTML =
    data.map(p=>`<div>${p.title} - $${(p.price_cents/100).toFixed(2)}</div>`).join("");
};

supabase.auth.onAuthStateChange((event, session)=>{
  document.getElementById("auth").innerText =
    session ? "已登录: "+session.user.email : "未登录";
  log("Auth: "+event);
});

</script>

</body>
</html>
